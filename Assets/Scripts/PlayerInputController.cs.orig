using UnityEngine;
using Elympics;

[RequireComponent(typeof(PlayerBehaviour))]
public class PlayerInputController : ElympicsMonoBehaviour, IInitializable, IInputHandler
{
	[SerializeField] private PlayerFPSInputProvider inputProvider = null;

	private PlayerBehaviour _playerBehaviour;

	public void GetInputForClient(IInputWriter inputSerializer)
	{
		inputProvider.GetRawInput(out var movement, out var rotation, out var fire, out var jump);
		SerializeInput(inputSerializer, movement, rotation, fire, jump);
	}

	public void GetInputForBot(IInputWriter inputSerializer)
	{
		// if you want to implement bots, you can take their inputs here
	}

	private static void SerializeInput(IInputWriter inputWriter, Vector2 movement, Vector2 rotation, bool fire, bool jump)
	{
		// write all input variables, you can add more if you want but remember to read all variables in ApplyInput
		inputWriter.Write(movement.x);
		inputWriter.Write(movement.y);
		inputWriter.Write(rotation.x);
		inputWriter.Write(rotation.y);
		inputWriter.Write(fire);
		inputWriter.Write(jump);
	}

	public void ApplyInput(int playerId, IInputReader inputReader)
	{
		// remember to read all input variables in the same order they were written in
		inputReader.Read(out float forwardMovement);
		inputReader.Read(out float rightMovement);
		inputReader.Read(out float rightRotation);
		inputReader.Read(out float upRotation);
		inputReader.Read(out bool fire);
		inputReader.Read(out bool jump);

		// check ownership of the player behaviour
		if (playerId != _playerBehaviour.associatedPlayerId)
			return;

		// apply inputs to player behaviour
		if (fire)
			_playerBehaviour.Fire();
		_playerBehaviour.Move(forwardMovement, rightMovement, rightRotation, upRotation);
		if (jump)
			_playerBehaviour.Jump();

		// you can add and apply any other input you wish here
	}

	public void Initialize()
	{
		_playerBehaviour = GetComponent<PlayerBehaviour>();
	}
}
